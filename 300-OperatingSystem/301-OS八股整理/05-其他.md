
## 01 内核态和用户态

### 什么是内核态和用户态

**内核态**（系统态）与**用户态**是操作系统的两种运行级别。内核态拥有最高权限，可以访问所有系统指令；用户态则只能访问一部分指令。
1. 内核态：
- 在内核态下，操作系统内核拥有最高的权限和访问级别。
- 内核态具有对系统硬件和所有资源的完全控制权，可以执行特权指令和访问敏感的系统资源。
- 在内核态下执行操作系统内核的一些功能，比如进程调度、内存管理、文件管理等。
2. 用户态：
- 用户态下，程序只能访问受限的资源和执行受限的指令，不能直接访问硬件或执行特权操作。
- 应用程序通常在用户态下运行，受到操作系统的保护，无法直接干扰其他应用程序或操作系统的正常运行。
- 用户态下的程序执行受限的指令，而对于需要进行系统级别的任务，必须通过系统调用（system call）进入内核态，请求内核执行相应的任务。

相关问题：用户态和内核态分别会做什么？说说内核态和用户态

### 什么时候进入内核态

有三种方式可以从内核态切换到用户态：1. **系统调用**、2. **异常**、3. **设备中断**。其中，系统调用是主动的，另外两种是被动的。

相似问题：用户态怎么切换到内核态？用户程序想访问硬件资源应怎么办？
### 为什么要区分内核态和用户态

- 主要是为了实现操作系统和用户程序之间的**强隔离**，以及为了**安全性**考虑的，如果应用程序出错，不应该导致操作系统出问题，或者影响到其他的应用程序，而操作系统应该有权力清理失败的应用程序，并继续运行其他应用程序。
- 要实现强隔离的话，**操作系统必须保证应用程序不能修改（甚至读取）操作系统内核的数据结构和指令，以及应用程序不能访问其他进程的内存**。
- 一般来说 CPU 指令集会为强隔离提供硬件支持，比如 RISC-V 当中有三种 CPU 可以执行指令的模式：机器模式 (Machine Mode)、用户模式 (User Mode) 和管理模式 (Supervisor Mode)
	- 机器模式拥有所有指令集的使用权限，CPU 在机器模式下启动，主要用于配置计算机；
	- 管理模式下，CPU 被允许执行特权指令，如启用和禁用中断、读取和写入保存页表地址的寄存器等；
	- 应用程序只能执行用户模式的指令（例如，数字相加等），如果在用户模式下访问了特权指令，CPU 不会执行该指令，而是切换到管理模式，以便管理模式能够终止应用程序。

### 系统调用、中断和异常

系统调用、中断和异常是操作系统从用户态切换到内核态的三种方式：
1. **系统调用（System Call）**：系统调用是用户想要操作系统内核提供的资源服务，主动发起的，一般来说操作系统内核会实现一组系统功能的子程序，用户通过系统调用命令在自己的用户程序当中调用它们。
2. **中断（Interrupt）**：中断一般是由外部硬件设备或者其他处理器引起的，让当前的 CPU 中断当前正在执行的任务，转而执行与中断相关的处理程序（中断服务例程）。比如时钟中断、IO 中断等等。
3. **异常（Exception）**：异常指的是正在运行的程序执行的过程当中，出现一些错误或者不寻常的情况，比如说除零错误、访问异常的内存页面等等。

它们三者的区别和联系：
- 1）系统调用和异常都是**同步**机制，而中断是**异步**机制，源于外部的硬件或其他处理器发起的。
- 2）只有系统调用是用户程序主动发起的，而中断和异常都是被动的。
- 3）这三种机制都需要相应的处理程序，确保在切换到内核态的时候，操作系统可以正确的处理它们。

### 用户态如何切换到内核态的详细原理

当发生系统调用、中断或异常的时候，这里简单统称为异常（便于下面描述），需要从用户态切换到内核态，主要分为下面几个过程（这里以 RISC-V 为例）：
1. **CPU 自动做的事情**：CPU 会保存当前 pc 值、异常的类型、发生异常的虚拟地址、异常之前处理器的模式等内容保存在对应的寄存器当中，然后关闭本地中断，将处理器的模式设置为内核模式，然后跳转到异常向量表。
2. **操作系统内核做的事情**：操作系统会将异常发生的上下文，包括所有的通用寄存器，以及 S 模式下一些寄存器的值，这些上下文会保存在栈当中。然后通过查询 scause 寄存器来得到异常或中断的编号，从而跳转到合适的处理程序当中，最后执行 sret 指令，返回异常现场。
3. **异常返回**：操作系统处理完之后，CPU 会恢复触发异常之前中断的状态，然后将处理器模式切换为之前的模式，然后恢复 pc 寄存器的值，相当于返回触发异常的位置。

这里详细的原理大概说一下应该就行了，相应的一些寄存器不同的指令集不太一样，感兴趣的可以参考以下 xv6 相关的内容：
- [第四章 陷阱指令和系统调用 · 6.S081 All-In-One (dgs.zone)](http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/c4/s1.html)
- [04 - xv6 异常处理](../xv6-lab-2022/04%20-%20xv6%20异常处理.md)
